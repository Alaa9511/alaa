from flask import Flask, render_template, request, jsonify
import requests
from bs4 import BeautifulSoup
import re
import random
from collections import Counter
import nltk
from nltk.corpus import stopwords

app = Flask(__name__)

# تحميل كلمات التوقف
nltk.download('stopwords')
stop_words = set(stopwords.words('arabic') + stopwords.words('english'))

# دالة استخراج الكلمات المفتاحية
def extract_keywords(words):
    filtered = [w for w in words if w not in stop_words and not w.startswith('http')]
    counts = Counter(filtered)
    common = counts.most_common(100)
    return [w for w, _ in common]

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/analyze', methods=['POST'])
def analyze():
    url = request.json['url']
    try:
        response = requests.get(url, timeout=10)
        soup = BeautifulSoup(response.text, 'html.parser')

        title = soup.title.string.strip() if soup.title else "لا يوجد عنوان"
        desc_tag = soup.find('meta', attrs={'name': 'description'})
        description = desc_tag['content'].strip() if desc_tag else "لا يوجد وصف"

        # استخراج صورة المنتج
        img_tag = soup.find('meta', property='og:image') or soup.find('img')
        image_url = img_tag['content'] if img_tag and img_tag.has_attr('content') else (
            img_tag['src'] if img_tag and img_tag.has_attr('src') else "")

        # استخراج نص الصفحة والكلمات
        text = soup.get_text(separator=' ')
        words = re.findall(r'\b[\w-]{3,}\b', text.lower())
        keywords = extract_keywords(words)

        # فصل الكلمات المفتاحية
        arabic_keywords = list({w for w in keywords if re.search(r'[\u0600-\u06FF]', w)})
        english_keywords = list({w for w in keywords if w.isascii() and not re.search(r'[\u0600-\u06FF]', w)})

        # كلمات تسويقية
        marketing_words = ["شراء", "بيع", "خصومات", "تسوق", "أضف للسلة", "شحن مجاني", "أفضل العطور", "عطر فاخر", "عطر ثابت"]
        arabic_keywords += marketing_words

        # إعادة ترتيب الكلمات وإزالة التكرار
        random.shuffle(arabic_keywords)
        random.shuffle(english_keywords)
        arabic_keywords = list(dict.fromkeys(arabic_keywords))
        english_keywords = list(dict.fromkeys(english_keywords))

        # توليد عنوان SEO
        product_name = title.split()[0] if title else "عطر"
        arabic_seo_title = f"عطر {product_name} - فخامة وثبات يدوم | لافيش"
        english_seo_title = f"{product_name} Perfume - Luxury & Long-lasting | Lavish"

        return jsonify({
            "title": title,
            "description": description,
            "arabic_keywords": '، '.join(arabic_keywords)[:160],
            "english_keywords": ', '.join(english_keywords[:20]),
            "arabic_seo_title": arabic_seo_title,
            "english_seo_title": english_seo_title,
            "image_url": image_url
        })
    except Exception as e:
        return jsonify({"error": str(e)})
